name: Daily CI Summary

on:
  schedule:
    # Try at 8 AM, 12 PM, and 4 PM UTC
    # Send once per day - first successful attempt wins
    - cron: '0 8 * * *'
    - cron: '0 12 * * *'
    - cron: '0 16 * * *'
  
  workflow_dispatch:
    # Manual trigger for testing
    inputs:
      force:
        description: 'Force send even if already sent today'
        type: boolean
        default: false

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
      
      - name: Get today's date
        id: date
        run: |
          TODAY=$(date -u '+%Y-%m-%d')
          echo "today=$TODAY" >> $GITHUB_OUTPUT
          echo "Today is: $TODAY"
      
      - name: Check if already sent today
        id: check-sent
        uses: actions/cache@v4
        with:
          path: .slack-sent-marker
          key: slack-daily-summary-${{ steps.date.outputs.today }}
          lookup-only: true
      
      - name: Skip if already sent today
        if: steps.check-sent.outputs.cache-hit == 'true' && github.event.inputs.force != 'true'
        run: |
          echo "âœ… Already sent notification for ${{ steps.date.outputs.today }}, skipping"
          echo "Use 'force' option in manual trigger to send anyway"
      
      - name: Check if nightly ran today
        id: check-nightly
        if: steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if nightly workflow ran today..."
          
          TODAY="${{ steps.date.outputs.today }}"
          
          # Check for completed nightly runs that started today
          NIGHTLY_RUN=$(gh api repos/kata-containers/kata-containers/actions/workflows/ci-nightly.yaml/runs \
            -q ".workflow_runs[] | select(.created_at | startswith(\"$TODAY\")) | select(.status == \"completed\") | .id" | head -1)
          
          if [ -z "$NIGHTLY_RUN" ]; then
            echo "â³ No completed nightly run found for today ($TODAY)"
            echo "Will retry at next scheduled time"
            echo "nightly_ran=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found completed nightly run: $NIGHTLY_RUN"
            echo "nightly_ran=true" >> $GITHUB_OUTPUT
            echo "run_id=$NIGHTLY_RUN" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Node.js
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        run: npm install js-yaml
      
      - name: Generate summary
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        id: summary
        run: |
          node scripts/generate-summary.js > summary.json
          cat summary.json
          
          # Extract key stats for the message
          echo "pass_rate=$(jq -r '.overall_pass_rate' summary.json)" >> $GITHUB_OUTPUT
          echo "total=$(jq -r '.total_tests' summary.json)" >> $GITHUB_OUTPUT
          echo "failed=$(jq -r '.failed_count' summary.json)" >> $GITHUB_OUTPUT
          echo "not_run=$(jq -r '.not_run_count' summary.json)" >> $GITHUB_OUTPUT
          echo "passed=$(jq -r '.passed_count' summary.json)" >> $GITHUB_OUTPUT
          
          # Build failing tests header with arch breakdown
          arch_summary=$(jq -r '.failing_arch_summary // ""' summary.json)
          if [ -n "$arch_summary" ]; then
            echo "failing_header=ðŸ”´ Failing Tests ${arch_summary}" >> $GITHUB_OUTPUT
          else
            echo "failing_header=ðŸ”´ Failing Tests" >> $GITHUB_OUTPUT
          fi
          
          # Build flaky tests header with arch breakdown
          flaky_arch_summary=$(jq -r '.flaky_arch_summary // ""' summary.json)
          if [ -n "$flaky_arch_summary" ]; then
            echo "flaky_header=âš¡ Flaky Tests ${flaky_arch_summary}" >> $GITHUB_OUTPUT
          else
            echo "flaky_header=âš¡ Flaky Tests" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack notification
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Skip if no webhook configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No SLACK_WEBHOOK_URL secret configured, skipping notification"
            exit 0
          fi
          
          # Calculate status emoji
          pass_rate=${{ steps.summary.outputs.pass_rate }}
          if [ "$pass_rate" -ge 95 ]; then
            status_emoji="â˜€ï¸"
            status_text="Excellent"
          elif [ "$pass_rate" -ge 85 ]; then
            status_emoji="ðŸŒ¤ï¸"
            status_text="Good"
          elif [ "$pass_rate" -ge 70 ]; then
            status_emoji="â›…"
            status_text="Fair"
          elif [ "$pass_rate" -ge 50 ]; then
            status_emoji="ðŸŒ§ï¸"
            status_text="Needs Attention"
          else
            status_emoji="â›ˆï¸"
            status_text="Critical"
          fi
          
          # Get arch breakdowns and 10-day averages from summary
          failed_count=${{ steps.summary.outputs.failed }}
          failing_arch=$(jq -r '.failing_arch_summary // ""' summary.json)
          ten_day_avg_failed=$(jq -r '.ten_day_avg_failed // 0' summary.json)
          failed_delta=$(jq -r '.failed_delta // 0' summary.json)
          
          flaky_count=$(jq -r '.flaky_tests | length' summary.json)
          flaky_arch=$(jq -r '.flaky_arch_summary // ""' summary.json)
          ten_day_avg_flaky=$(jq -r '.ten_day_avg_flaky // 0' summary.json)
          flaky_delta=$(jq -r '.flaky_delta // 0' summary.json)
          
          # Build 10-day average comparison for failed jobs
          # Use awk for floating point comparison
          failed_cmp_dir=$(echo "$failed_delta" | awk '{if ($1 > 0.5) print "above"; else if ($1 < -0.5) print "below"; else print "at"}')
          if [ "$failed_cmp_dir" = "above" ]; then
            avg_cmp="(â†‘ 10d avg: ${ten_day_avg_failed})"
          elif [ "$failed_cmp_dir" = "below" ]; then
            avg_cmp="(â†“ 10d avg: ${ten_day_avg_failed})"
          else
            avg_cmp="(â†’ 10d avg: ${ten_day_avg_failed})"
          fi
          
          # Build 10-day average comparison for flaky jobs
          flaky_cmp_dir=$(echo "$flaky_delta" | awk '{if ($1 > 0.5) print "above"; else if ($1 < -0.5) print "below"; else print "at"}')
          if [ "$flaky_cmp_dir" = "above" ]; then
            flaky_avg_cmp="(â†‘ 10d avg: ${ten_day_avg_flaky})"
          elif [ "$flaky_cmp_dir" = "below" ]; then
            flaky_avg_cmp="(â†“ 10d avg: ${ten_day_avg_flaky})"
          else
            flaky_avg_cmp="(â†’ 10d avg: ${ten_day_avg_flaky})"
          fi
          
          # Build summary lines
          if [ "$failed_count" -eq 0 ]; then
            failed_line="ðŸ”´ *0 jobs failed* ðŸŽ‰ ${avg_cmp}"
          else
            failed_line="ðŸ”´ *${failed_count} jobs failed* ${failing_arch} ${avg_cmp}"
          fi
          
          if [ "$flaky_count" -eq 0 ]; then
            flaky_line="âš¡ *0 jobs are flaky* ${flaky_avg_cmp}"
          else
            flaky_line="âš¡ *${flaky_count} jobs are flaky* ${flaky_arch} ${flaky_avg_cmp}"
          fi
          
          # Send to Slack webhook
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${status_emoji} Kata CI Nightly Summary",
                  "emoji": true
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "$(date -u '+%A, %B %d, %Y')"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Pass Rate*\n${status_emoji} ${pass_rate}%"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status*\n${status_text}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Jobs*\n${{ steps.summary.outputs.total }} total"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Results*\nðŸŸ¢ ${{ steps.summary.outputs.passed }} | ðŸ”´ ${{ steps.summary.outputs.failed }} | ðŸŸ¡ ${{ steps.summary.outputs.not_run }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${failed_line}\n${flaky_line}\n\nðŸ“Š <https://kata-containers.github.io/ci-dashboard/|View details on CI Dashboard>"
                }
              }
            ]
          }
          EOF
          
          echo "âœ… Slack notification sent!"
      
      - name: Create sent marker
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        run: |
          echo "Sent notification for ${{ steps.date.outputs.today }} at $(date -u)" > .slack-sent-marker
      
      - name: Save sent marker to cache
        if: (steps.check-sent.outputs.cache-hit != 'true' || github.event.inputs.force == 'true') && steps.check-nightly.outputs.nightly_ran == 'true'
        continue-on-error: true  # Cache may already exist from concurrent run
        uses: actions/cache/save@v4
        with:
          path: .slack-sent-marker
          key: slack-daily-summary-${{ steps.date.outputs.today }}
