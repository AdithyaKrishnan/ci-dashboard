name: Daily CI Summary

on:
  schedule:
    # Run at 8:00 AM UTC every day (after nightly tests complete)
    - cron: '0 8 * * *'
  
  workflow_dispatch:
    # Manual trigger for testing

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install js-yaml
      
      - name: Fetch latest nightly data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching latest nightly run data..."
          
          # Fetch nightly workflow runs (last 10 days)
          gh api repos/kata-containers/kata-containers/actions/workflows/ci-nightly.yaml/runs \
            --paginate -q '.workflow_runs[:10]' > raw-runs.json
          
          # Fetch jobs for each run
          echo "Fetching jobs for each run..."
          for run_id in $(jq -r '.[].id' raw-runs.json); do
            echo "  Fetching jobs for run $run_id..."
            gh api "repos/kata-containers/kata-containers/actions/runs/${run_id}/jobs?filter=all&per_page=100" \
              -q '.jobs' > "jobs-${run_id}.json" 2>/dev/null || echo "[]" > "jobs-${run_id}.json"
          done
          
          # Merge all jobs into all-jobs.json
          echo "Merging job data..."
          cat jobs-*.json | jq -s 'add // []' > all-jobs.json
          
          # Process the data
          echo "Processing data..."
          node scripts/process-data.js
          
          echo "Data refresh complete!"
      
      - name: Generate summary
        id: summary
        run: |
          node scripts/generate-summary.js > summary.json
          cat summary.json
          
          # Extract key stats for the message
          echo "pass_rate=$(jq -r '.overall_pass_rate' summary.json)" >> $GITHUB_OUTPUT
          echo "total=$(jq -r '.total_tests' summary.json)" >> $GITHUB_OUTPUT
          echo "failed=$(jq -r '.failed_count' summary.json)" >> $GITHUB_OUTPUT
          echo "passed=$(jq -r '.passed_count' summary.json)" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Skip if no webhook configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No SLACK_WEBHOOK_URL secret configured, skipping notification"
            exit 0
          fi
          
          # Calculate status emoji
          pass_rate=${{ steps.summary.outputs.pass_rate }}
          if [ "$pass_rate" -ge 95 ]; then
            status_emoji="‚òÄÔ∏è"
            status_text="Excellent"
          elif [ "$pass_rate" -ge 85 ]; then
            status_emoji="üå§Ô∏è"
            status_text="Good"
          elif [ "$pass_rate" -ge 70 ]; then
            status_emoji="‚õÖ"
            status_text="Fair"
          elif [ "$pass_rate" -ge 50 ]; then
            status_emoji="üåßÔ∏è"
            status_text="Needs Attention"
          else
            status_emoji="‚õàÔ∏è"
            status_text="Critical"
          fi
          
          # Build section breakdown
          sections_text=$(jq -r '.sections | map("‚Ä¢ *\(.name)*: \(.weather_emoji) \(.pass_rate)% (\(.failed) failed)") | join("\\n")' summary.json)
          
          # Build failing tests list (top 5)
          failing_tests=$(jq -r '
            .failing_tests[:5] | 
            if length == 0 then "None! üéâ" 
            else map("‚Ä¢ `\(.name)` - \(.error_step) (\(.days_failing)d)") | join("\\n") 
            end
          ' summary.json)
          
          # Build flaky tests list (top 3)
          flaky_tests=$(jq -r '
            .flaky_tests[:3] | 
            if length == 0 then "None detected" 
            else map("‚Ä¢ `\(.name)` - \(.flaky_rate)% flaky") | join("\\n") 
            end
          ' summary.json)
          
          # Send to Slack webhook
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${status_emoji} Kata CI Nightly Summary",
                  "emoji": true
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "$(date -u '+%A, %B %d, %Y') ‚Ä¢ <https://kata-containers.github.io/kata-ci-dashboard/|Open Dashboard>"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Pass Rate*\n${status_emoji} ${pass_rate}%"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status*\n${status_text}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Tests*\n${{ steps.summary.outputs.total }} total"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Results*\nüü¢ ${{ steps.summary.outputs.passed }} | üî¥ ${{ steps.summary.outputs.failed }}"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üìä By Section*\n${sections_text}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üî¥ Failing Tests (top 5)*\n${failing_tests}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*‚ö° Flaky Tests (top 3)*\n${flaky_tests}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìä Open Dashboard",
                      "emoji": true
                    },
                    "url": "https://kata-containers.github.io/kata-ci-dashboard/",
                    "style": "primary"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üîß GitHub Actions",
                      "emoji": true
                    },
                    "url": "https://github.com/kata-containers/kata-containers/actions/workflows/ci-nightly.yaml"
                  }
                ]
              }
            ]
          }
          EOF
          
          echo "Slack notification sent!"
